<?xml version="1.0" encoding="UTF-8"?>

<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
			 typeLanguage="http://www.w3.org/2001/XMLSchema"
			 expressionLanguage="http://www.w3.org/1999/XPath" targetNamespace="pUnit">
	<error id="testFailedError" errorCode="123"/>

	<process id="expectError-pTest" name="ExpectError">

		<startEvent id="start" />
		<sequenceFlow id="flow1" sourceRef="start" targetRef="createEngine" />
		
		<scriptTask id="createEngine" name="createEngine" scriptFormat="Groovy">
			<script>
				testProcessEngineConfiguration = org.activiti.engine.ProcessEngineConfiguration.createProcessEngineConfigurationFromResource("activiti.cfg.xml");
				testProcessEngineConfiguration.buildProcessEngine();
			</script>
		</scriptTask>
		<sequenceFlow id="flow2" sourceRef="createEngine" targetRef="deployProcessModel" />

		<scriptTask id="deployProcessModel" name="deployProcessModel" scriptFormat="Groovy">
			<script>
				testProcessEngine = org.activiti.engine.ProcessEngines.getProcessEngine("processEngineToPerformTest");
				repositoryService = testProcessEngine.getRepositoryService();
				repositoryService.createDeployment().addClasspathResource("org/activiti/process/model/processToTest-error.bpmn20.xml").deploy();
			</script>
		</scriptTask>
		<sequenceFlow id="flow3" sourceRef="deployProcessModel" targetRef="startProcessInstance"/>

		<scriptTask id="startProcessInstance" name="startProcessInstance" scriptFormat="Groovy">
			<script>
				testProcessEngine = org.activiti.engine.ProcessEngines.getProcessEngine("processEngineToPerformTest");
				processToTest = testProcessEngine.getRuntimeService().startProcessInstanceByKey("processToTest-error");
				execution.setVariable("processInstanceId", processToTest.getProcessInstanceId());
			</script>
		</scriptTask>
		<sequenceFlow id="flow4" sourceRef="startProcessInstance" targetRef="completeTask1"/>

		<scriptTask id="completeTask1" name="completeTask1" scriptFormat="Groovy">
			<script>
				testProcessEngine = org.activiti.engine.ProcessEngines.getProcessEngine("processEngineToPerformTest");
				task = testProcessEngine.getTaskService().createTaskQuery().taskName("Activiti is awesome!").singleResult();
				variables = new java.util.HashMap();
				variables.put("updatedVariable", "updatedValue");
				testProcessEngine.getTaskService().complete(task.getId(), variables);
			</script>
		</scriptTask>
		<sequenceFlow id="flow5" sourceRef="completeTask1" targetRef="testFailed"/>

		<boundaryEvent id="expectError" attachedToRef="completeTask1">
			<errorEventDefinition/>
		</boundaryEvent>
		<sequenceFlow id="flow6" sourceRef="expectError" targetRef="closeEngine"/>

		<scriptTask id="closeEngine" name="Close engine" scriptFormat="Groovy">
			<script>
				testProcessEngine = org.activiti.engine.ProcessEngines.getProcessEngine("processEngineToPerformTest");
				testProcessEngine.close();
			</script>
		</scriptTask>
		<sequenceFlow id="flow9" sourceRef="closeEngine" targetRef="end"/>

		<endEvent id="end" />

		<endEvent id="testFailed">
			<errorEventDefinition errorRef="testFailedError"/>
		</endEvent>

	</process>

</definitions>